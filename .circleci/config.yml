# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
commands:
  setup-docker:
    steps:
      - setup_remote_docker:
          version: 20.10.11
      - run: docker version
  setup-buildx:
    steps:
      - run:
          name: Show docker info
          command: |-
            docker version
            docker buildx version
            docker context inspect
      - run:
          name: Setup docker buildx
          command: |-
            docker context create circleci
            docker buildx create --use circleci
            docker buildx ls
            docker context inspect circleci
executors:
  cimg-docker:
    docker:
      - image: cimg/base:2022.03
        environment:
          IMAGE: ghcr.io/kesin11/circleci-cli-sandbox
    resource_class: medium
jobs:
  docker-build-registry-cache:
    executor:
      name: cimg-docker
    steps:
      - checkout
      - setup-docker
      - setup-buildx
      - run:
          name: docker login
          command: echo $GITHUB_CR_PAT | docker login ghcr.io -u kesin11 --password-stdin
      - run:
          name: Docker build with registry cache
          command: docker buildx build --progress=plain -f Dockerfile --cache-to=type=registry,mode=max,ref=$IMAGE:cache --cache-from=type=registry,ref=$IMAGE:cache -t $IMAGE:latest .
workflows:
  build:
    jobs:
      - docker-build-registry-cache

